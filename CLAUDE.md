# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

POE Idol Planner is a Path of Exile idol planning tool for the Legacy of Phrecia event. Built with React Router 7 (SSR-enabled) deployed as a Cloudflare Worker. Uses React 19, TypeScript 5.9, Tailwind CSS 4, and shadcn/ui (new-york style).

## Commands

| Command | Purpose |
|---------|---------|
| `pnpm run dev` | Start dev server with hot reload |
| `pnpm run build` | Build for production |
| `pnpm run test` | Run tests once |
| `pnpm run test:watch` | Run tests in watch mode |
| `pnpm run deploy:prod:cf` | Build and deploy to production |
| `pnpm run deploy:dev:cf` | Build and deploy to dev environment |
| `pnpm run biome` | Format and lint code (auto-fix) |
| `pnpm run biome:ci` | Lint in CI mode (no write) |
| `pnpm run types` | Run all type checks (cf + rr + tsc) |
| `pnpm run types:cf` | Generate Cloudflare bindings types |
| `pnpm run types:rr` | Generate React Router route types |
| `pnpm run precommit` | Run biome:ci + types (use before committing) |

## Architecture

### Entry Points
- `workers/app.ts` - Cloudflare Worker fetch handler, creates request handler and passes context
- `app/entry.server.tsx` - SSR streaming handler using `renderToReadableStream`, includes bot detection
- `app/root.tsx` - Root layout component with error boundary and HTML shell

### Routing
- `app/routes.ts` - Route configuration using React Router v7 config API
- `app/routes/` - Route components with loaders and meta functions
- Route types auto-generated in `.react-router/types/`

### Context System
- `app/context.ts` - Defines `envContext` and `exeContext` using React Router's `createContext`
- Access Cloudflare bindings via `context.get(envContext)` in loaders
- Types from `CloudflareBindings` (generated by wrangler)

### Cloudflare Integration
- KV namespace `KV_SAVE` available for persistent storage
- Environment configs: `worker-prod` (poe-idol-planner.ta2.dev), `worker-dev` (poe-idol-planner-dev.ta2.dev)
- Bindings typed via `pnpm run types:cf`

### UI Components
- shadcn/ui configured with new-york style and neutral base color
- Components go in `app/components/ui/`
- Uses `tw-animate-css` for animations
- Add components via: `pnpx shadcn@latest add <component>`

## Code Conventions

### Path Aliases
- `~/` maps to `./app/` for application imports
- `~test/` maps to `./test/` for test imports
- **Always use path aliases** instead of relative imports (e.g., `~/components/Button` not `../../components/Button`)

### Formatting (Biome)
- Tab indentation (width 4)
- Auto-sorted Tailwind classes (`useSortedClasses`)
- Unused imports warned

### File Suffixes
- `.server.ts/.tsx` - Server-only code (not bundled for client)
- `.client.ts/.tsx` - Client-only code (not run on server)

### Environment Variables
- Define in `wrangler.jsonc` `vars` section for each environment
- Access via `envContext` in loaders

### Testing
- Use Vitest for unit tests
- Test files go in `test/` directory with `.test.ts` or `.test.tsx` extension
- **Unit-testable components should have snapshot tests** using `expect(component).toMatchSnapshot()`
- Run tests with `pnpm run test` or `pnpm run test:watch` for watch mode

## Changesets

Use `/changeset` to create changelog entries for version management.

Changeset format in `.changeset/<name>.md`:
```markdown
---
"poe-idol-planner": <patch|minor|major>
---

<description>
```

Guidelines:
- `patch`: Bug fixes, documentation updates, config changes
- `minor`: New features, non-breaking enhancements
- `major`: Breaking changes (avoid for 0.x versions)

## Current Development

See `plan/task_plan.md` for project phases and implementation details. Key features being built:
- Idol inventory and grid placement UI
- Import from POE clipboard (Ctrl+C and Ctrl+Alt+C formats)
- Multiple idol sets management with localStorage persistence
- Share sets via Cloudflare KV
- Trade search URL generation
- Localization support (10 languages)

### Logging

The app uses **Cloudflare Workers Observability** for logging. Always log objects (not strings) so that keys can be indexed and queried in the dashboard.

```ts
// Good - object with indexed keys
console.log({ message: "Sync started", themeId, shop, fileCount: files.length });

// Bad - plain string (not indexable)
console.log(`Sync started for theme ${themeId}`);
```