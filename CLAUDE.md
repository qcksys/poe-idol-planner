# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

POE Idol Planner is a Path of Exile idol planning tool for the Legacy of Phrecia event. Built with React Router 7 (SSR-enabled) deployed as a Cloudflare Worker. Uses React 19, TypeScript 5.9, Tailwind CSS 4, and shadcn/ui (new-york style).

## Commands

| Command | Purpose |
|---------|---------|
| `pnpm run dev` | Start dev server with hot reload |
| `pnpm run build` | Build for production |
| `pnpm run test` | Run tests once |
| `pnpm run test:watch` | Run tests in watch mode |
| `pnpm run deploy:prod:cf` | Build and deploy to production |
| `pnpm run deploy:dev:cf` | Build and deploy to dev environment |
| `pnpm run biome` | Format and lint code (auto-fix) |
| `pnpm run biome:ci` | Lint in CI mode (no write) |
| `pnpm run types` | Run all type checks (cf + rr + tsc) |
| `pnpm run types:cf` | Generate Cloudflare bindings types |
| `pnpm run types:rr` | Generate React Router route types |
| `pnpm run precommit` | Run biome:ci + types (use before committing) |
| `pnpm run data:convert` | Fetch and convert idol data from poedb.tw |
| `pnpm run data:convert:cached` | Convert using cached poedb data |
| `vitest run path/to/file.test.ts` | Run a single test file |

## Architecture

### Entry Points
- `workers/app.ts` - Cloudflare Worker fetch handler, creates request handler and passes context
- `app/entry.server.tsx` - SSR streaming handler using `renderToReadableStream`, includes bot detection
- `app/root.tsx` - Root layout component with error boundary and HTML shell

### Routing
- `app/routes.ts` - Route configuration using React Router v7 config API
- `app/routes/` - Route components with loaders and meta functions
- Route types auto-generated in `.react-router/types/`

### Context System
- `app/context.ts` - Defines `envContext` and `exeContext` using React Router's `createContext`
- Access Cloudflare bindings via `context.get(envContext)` in loaders
- Types from `CloudflareBindings` (generated by wrangler)

### Cloudflare Integration
- KV namespace `KV_SAVE` available for persistent storage
- Environment configs: `worker-prod` (poe-idol-planner.prae2.com), `worker-dev` (poe-idol-planner-dev.prae2.com)
- Bindings typed via `pnpm run types:cf`

### UI Components
- shadcn/ui configured with new-york style and neutral base color
- Components go in `app/components/ui/`
- Uses `tw-animate-css` for animations
- Add components via: `pnpx shadcn@latest add <component>`

### State Management
The app uses a centralized state pattern with localStorage persistence:

- `app/hooks/use-planner-state.ts` - Top-level hook combining inventory and sets state, handles hydration and auto-save
- `app/hooks/use-inventory.ts` - Manages imported idols collection
- `app/hooks/use-idol-sets.ts` - Manages named sets with grid placements
- `app/context/dnd-context.tsx` - React context for drag-and-drop state between inventory and grid

**Data Flow:**
```
Import (clipboard) → Inventory → Drag to Set → Grid Position
                         ↓
                   Same idol can be in multiple sets
                         ↓
              Delete from inventory = removes everywhere
```

### Schemas (Zod 4)
All data validated with Zod schemas in `app/schemas/`:
- `idol.ts` - Base idol types, modifiers, instances
- `idol-set.ts` - Named sets with grid placements
- `inventory.ts` - Imported idols with usage tracking
- `storage.ts` - Complete localStorage format with version

### i18n System
Lightweight client-side localization in `app/i18n/`:
- `I18nProvider` wraps app, handles hydration
- `useI18n()` returns `{ locale, setLocale, t }`
- `useTranslations()` returns translation object directly
- Translations in `app/i18n/locales/*.json`
- Locale stored in localStorage, can override via `?lang=` param

## Code Conventions

### Path Aliases
- `~/` maps to `./app/` for application imports
- `~test/` maps to `./test/` for test imports
- **Always use path aliases** instead of relative imports (e.g., `~/components/Button` not `../../components/Button`)

### Formatting (Biome)
- Tab indentation (width 4)
- Auto-sorted Tailwind classes (`useSortedClasses`)
- Unused imports warned

### File Suffixes
- `.server.ts/.tsx` - Server-only code (not bundled for client)
- `.client.ts/.tsx` - Client-only code (not run on server)

### Environment Variables
- Define in `wrangler.jsonc` `vars` section for each environment
- Access via `envContext` in loaders

### Testing
- Use Vitest for unit tests
- Test files go in `test/` directory with `.test.ts` or `.test.tsx` extension
- **Unit-testable components should have snapshot tests** using `expect(component).toMatchSnapshot()`
- Run tests with `pnpm run test` or `pnpm run test:watch` for watch mode

### Git Workflow
- **Commit at relevant intervals** during development (do not push unless asked)
- Commit after completing logical units of work: a feature, bug fix, or meaningful refactor
- Run `pnpm run precommit` before committing to ensure code passes linting and type checks
- Write clear, concise commit messages describing what changed and why
- Prefer smaller, focused commits over large monolithic ones
- **Create a changeset BEFORE committing** using `/changeset` for version management
  - `patch`: Bug fixes, documentation updates, config changes
  - `minor`: New features, non-breaking enhancements
  - `major`: Breaking changes (avoid for 0.x versions)
  - The changeset file should be included in the same commit as the changes it describes

### Local Browser Testing (Chrome DevTools MCP)

Use Chrome DevTools MCP tools for interactive testing of the running application:

1. **Start the dev server**: `pnpm run dev` (runs on http://localhost:5173)

2. **Navigate and inspect**:
   - `mcp__chrome-devtools__navigate_page` - Navigate to localhost:5173
   - `mcp__chrome-devtools__take_snapshot` - Get accessible elements with UIDs
   - `mcp__chrome-devtools__take_screenshot` - Capture visual state

3. **Interact with UI**:
   - `mcp__chrome-devtools__click` - Click elements by UID
   - `mcp__chrome-devtools__fill` - Fill input/textarea fields
   - `mcp__chrome-devtools__hover` - Hover for tooltips

4. **Debug issues**:
   - `mcp__chrome-devtools__list_console_messages` - Check for errors/warnings
   - `mcp__chrome-devtools__list_network_requests` - Inspect API calls
   - `mcp__chrome-devtools__evaluate_script` - Run JS in page context

5. **Performance**:
   - `mcp__chrome-devtools__performance_start_trace` - Profile page load
   - `mcp__chrome-devtools__performance_stop_trace` - Get performance insights

Example workflow:
```
1. Navigate to http://localhost:5173
2. Take snapshot to see UI elements
3. Click "Import Idol" button by UID
4. Fill textarea with test idol data
5. Take screenshot to verify result
6. Check console for any errors
```

## Current Development

See `plan/task_plan.md` for project phases and implementation details. Key features being built:
- Idol inventory and grid placement UI
- Import from POE clipboard (Ctrl+C and Ctrl+Alt+C formats)
- Multiple idol sets management with localStorage persistence
- Share sets via Cloudflare KV
- Trade search URL generation
- Localization support (10 languages)

### Logging

The app uses **Cloudflare Workers Observability** for logging. Always log objects (not strings) so that keys can be indexed and queried in the dashboard.

```ts
// Good - object with indexed keys
console.log({ message: "Sync started", themeId, shop, fileCount: files.length });

// Bad - plain string (not indexable)
console.log(`Sync started for theme ${themeId}`);
```